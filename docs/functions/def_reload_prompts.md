# def_reload_prompts

## Описание функции

Функция `_reload_prompts()` обеспечивает **горячую перезагрузку системных промптов** без перезапуска приложения Streamlit. Это ключевой механизм для динамического управления поведением LLM в реальном времени.

## Расположение в коде

**Файл:** `app.py`  
**Строки:** 105-138

## Сигнатура функции

```python
def _reload_prompts():
    """
    Перечитать prompts.py на лету, вернуть словарь с системными блоками.
    Если какого-то блока нет — подставим дефолт и пометим предупреждение.
    """
```

## Параметры

Функция не принимает параметров.

## Возвращаемое значение

Кортеж из двух элементов:
- `p_map` (dict) - словарь с системными промптами
- `warn` (list) - список отсутствующих промптов для предупреждений

## Ключевые особенности

### 1. Горячая перезагрузка модуля
```python
importlib.reload(prompts)
```
- Принудительно перезагружает модуль `prompts.py`
- Подхватывает изменения в файле без перезапуска приложения
- Критично для итеративной разработки LLM-поведения

### 2. Безопасное извлечение промптов
```python
def _get(name, default):
    if hasattr(prompts, name):
        return getattr(prompts, name)
    else:
        warn.append(name)
        return default
```
- Проверяет существование атрибута в модуле
- Возвращает fallback-значение при отсутствии промпта
- Собирает предупреждения для отладки

### 3. Словарь системных промптов
```python
p_map = {
    "router": _get("ROUTER_PROMPT", "дефолт..."),
    "sql": _get("RULES_SQL", "дефолт..."),
    "rag": _get("RULES_RAG", "дефолт..."),
    "plotly": _get("RULES_PLOTLY", "дефолт..."),
}
```

## Структура промптов

### Router промпт
- **Назначение:** Определение режима работы (sql/rag/plotly/catalog)
- **Формат ответа:** ````mode\nsql\n````
- **Варианты:** sql, rag, plotly, catalog

### SQL промпт
- **Назначение:** Правила генерации SQL-запросов
- **Формат ответа:** Блок ````sql ...````
- **Особенности:** Лаконичность, точность

### RAG промпт
- **Назначение:** Правила поиска в базе знаний
- **Формат ответа:** Блок ````rag <запрос>````
- **Особенности:** Краткость запроса

### Plotly промпт
- **Назначение:** Правила создания графиков
- **Формат ответа:** Блок ````plotly```` с кодом
- **Требование:** Создание переменной `fig`

## Места использования

### 1. При каждом запросе пользователя
```python
prompts_map, _ = _reload_prompts()  # Строка 1035
```

### 2. Проверка предупреждений
```python
_prompts_map, _prompts_warn = _reload_prompts()  # Строка 1008
if _prompts_warn:
    st.warning("В `prompts.py` отсутствуют: " + ", ".join(_prompts_warn))
```

### 3. В различных режимах работы
- **Router режим** - определение типа запроса
- **SQL режим** - генерация запросов к БД
- **RAG режим** - поиск в базе знаний
- **Plotly режим** - создание визуализаций

## Дефолтные значения

При отсутствии промптов в `prompts.py` используются fallback-значения:

- **Router:** "Ты — маршрутизатор. Верни ровно один блок ```mode\nsql\n``` где sql|rag|plotly|catalog."
- **SQL:** "Режим SQL. Верни лаконичный ответ с одним блоком ```sql ...``` и не добавляй ничего лишнего."
- **RAG:** "Режим RAG. Сначала верни блок ```rag <краткий_запрос>```, без пояснений."
- **Plotly:** "Режим PLOTLY. Верни ровно один блок ```plotly``` с кодом, создающим переменную fig."

## Обработка ошибок

- Отсутствующие промпты не вызывают падение приложения
- Предупреждения отображаются в интерфейсе
- Дефолтные значения обеспечивают базовую функциональность

## Преимущества архитектуры

✅ **Гибкость** - изменение промптов без перезапуска  
✅ **Надежность** - fallback-механизм предотвращает падения  
✅ **Отладка** - явные предупреждения о проблемах  
✅ **Производительность** - загрузка только при необходимости  
✅ **Итеративность** - быстрая настройка LLM-поведения  

## Связанные файлы

- `prompts.py` - файл с системными промптами
- `app.py` - основное приложение (места использования)

## Пример использования

```python
# Загрузка актуальных промптов
prompts_map, warnings = _reload_prompts()

# Проверка предупреждений
if warnings:
    st.warning(f"Отсутствуют промпты: {', '.join(warnings)}")

# Использование в LLM-запросе
messages = [
    {"role": "system", "content": prompts_map["sql"]},
    {"role": "user", "content": user_input}
]
```

## Важность для системы

Эта функция является **критически важной** для:
- Динамического управления LLM-поведением
- Итеративной разработки промптов
- Обеспечения надежности системы
- Гибкой настройки различных режимов работы
