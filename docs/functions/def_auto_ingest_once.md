# def_auto_ingest_once

## Описание функции

Функция `_auto_ingest_once()` предназначена для автоматической индексации базы знаний при запуске приложения Streamlit.

## Расположение в коде

**Файл:** `app.py`  
**Строки:** 49-52

## Сигнатура функции

```python
@st.cache_resource  # гарантирует запуск ровно один раз на процесс Streamlit
def _auto_ingest_once():
    from ingest import run_ingest  # ленивый импорт, чтобы не тянуть зависимости зря
    return run_ingest()
```

## Параметры

Функция не принимает параметров.

## Возвращаемое значение

Словарь со статистикой индексации:
- `files` - количество обработанных файлов
- `chunks` - количество созданных чанков
- `added` - количество добавленных документов

## Особенности реализации

### 1. Кэширование с @st.cache_resource
- Декоратор `@st.cache_resource` гарантирует выполнение функции **только один раз** за весь жизненный цикл приложения Streamlit
- При повторных обращениях возвращается закэшированный результат
- Это предотвращает повторную индексацию при обновлении страницы или перезапуске компонентов

### 2. Ленивый импорт
- Импорт `from ingest import run_ingest` выполняется внутри функции
- Это позволяет не загружать модуль `ingest` и его зависимости, если функция не вызывается
- Экономит ресурсы и ускоряет запуск приложения

### 3. Интеграция с системой RAG
- Функция является частью системы Retrieval-Augmented Generation (RAG)
- Индексирует документы из папки `docs/` в базу данных ChromaDB
- Использует OpenAI embeddings для векторного поиска

## Использование в приложении

Функция вызывается автоматически при запуске приложения, если установлена переменная окружения:

```python
if os.getenv("KB_AUTO_INGEST_ON_START", "0") == "1":
    try:
        stats = _auto_ingest_once()
        # Показываем статистику в сайдбаре
        st.sidebar.success(
            f'Индекс обновлён: файлов {stats.get("files",0)}, '
            f'чанков {stats.get("chunks",0)}, добавлено {stats.get("added",0)}'
        )
    except Exception as e:
        st.sidebar.error(f"Автоиндексация не удалась: {e}")
```

## Зависимости

- `streamlit` - для декоратора `@st.cache_resource`
- `ingest.run_ingest` - основная функция индексации
- `os.getenv` - для проверки переменных окружения

## Обработка ошибок

- Ошибки индексации отображаются в сайдбаре приложения
- Приложение продолжает работать даже при неудачной индексации
- Статистика показывается только при успешном выполнении

## Пример вывода

При успешной индексации в сайдбаре отображается:
```
✅ Индекс обновлён: файлов 15, чанков 45, добавлено 45
```

При ошибке:
```
❌ Автоиндексация не удалась: OPENAI_API_KEY не задан
```

## Связанные функции

- `run_ingest()` в модуле `ingest.py` - основная функция индексации
- `_enhanced_table_search()` - поиск в индексированной базе знаний
- `retriever.retrieve()` - извлечение релевантных документов
