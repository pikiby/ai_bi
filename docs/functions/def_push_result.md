# def_push_result

## Описание функции

Функция `_push_result()` является **критически важной** для сохранения результатов работы (таблиц и графиков) в истории приложения. Обеспечивает персистентность данных между обновлениями страницы и возможность экспорта результатов.

## Расположение в коде

**Файл:** `app.py`  
**Строки:** 141-155

## Сигнатура функции

```python
def _push_result(kind: str, df_pl: pl.DataFrame | None = None,
                 fig: go.Figure | None = None, meta: dict | None = None):
```

## Параметры

### `kind: str` - Тип результата
- **`"table"`** - для SQL-результатов (таблицы)
- **`"chart"`** - для графиков Plotly
- **Обязательный параметр**

### `df_pl: pl.DataFrame | None` - Данные таблицы
- Polars DataFrame с результатами SQL-запроса
- `None` для графиков (данные не нужны)
- **Опциональный параметр**

### `fig: go.Figure | None` - Объект графика
- Plotly Figure для визуализации
- `None` для таблиц (график не нужен)
- **Опциональный параметр**

### `meta: dict | None` - Метаданные
- Дополнительная информация: SQL, заголовки, объяснения
- Пример: `{"sql": "SELECT ...", "title": "Топ городов", "explain": "..."}`
- **Опциональный параметр**

## Возвращаемое значение

Функция не возвращает значения (void). Результат сохраняется в `st.session_state["results"]`.

## Структура сохраняемых данных

```python
{
    "kind": kind,                    # Тип: "table" или "chart"
    "ts": datetime.now().isoformat(timespec="seconds"),  # Временная метка ISO
    "df_pl": df_pl,                 # Данные таблицы (Polars DataFrame)
    "fig": fig,                     # Объект графика (Plotly Figure)
    "meta": meta or {},             # Метаданные (SQL, заголовки, объяснения)
    "msg_idx": st.session_state.get("last_assistant_idx"),  # Связь с сообщением
}
```

## Ключевые особенности

### 1. Временная метка
```python
"ts": datetime.now().isoformat(timespec="seconds")
```
- ISO-формат времени для сортировки и идентификации
- Точность до секунд (достаточно для пользователя)
- Уникальная идентификация каждого результата

### 2. Связь с сообщением
```python
"msg_idx": st.session_state.get("last_assistant_idx")
```
- Привязывает результат к конкретному ответу ассистента
- Позволяет показывать результаты в правильном порядке
- Обеспечивает контекстную связь между диалогом и результатами

### 3. Гибкие данные
- **Таблицы** содержат `df_pl` (данные) + `meta` (SQL, заголовки)
- **Графики** содержат `fig` (визуализация) + `meta` (код Plotly)
- Оба типа могут иметь метаданные для дополнительной информации

## Места использования

### 1. Сохранение SQL-результатов
```python
_push_result("table", df_pl=df_pl, meta=meta_table)
```
- После выполнения SQL-запроса (строка 1251)
- Сохраняет таблицу с метаданными для последующего отображения

### 2. Сохранение графиков
```python
_push_result("chart", fig=fig, meta={"plotly_code": plotly_code})
```
- После создания Plotly-графика (строка 1399)
- Сохраняет визуализацию с кодом для экспорта

## Примеры использования

### Таблица с SQL-метаданными
```python
_push_result(
    kind="table",
    df_pl=df_pl,
    meta={
        "sql": "SELECT city, count(*) FROM users GROUP BY city",
        "title": "Топ городов",
        "explain": "Количество пользователей по городам",
        "sql_original": "исходный SQL от модели"
    }
)
```

### График с кодом
```python
_push_result(
    kind="chart", 
    fig=fig,
    meta={
        "plotly_code": "fig = px.bar(df, x='city', y='count')",
        "title": "График по городам",
        "explain": "Визуализация данных по городам"
    }
)
```

## Структура истории результатов

```python
st.session_state["results"] = [
    {
        "kind": "table",
        "ts": "2024-01-15T10:30:45",
        "df_pl": <Polars DataFrame>,
        "fig": None,
        "meta": {
            "sql": "SELECT city, count(*) FROM users GROUP BY city",
            "title": "Топ городов",
            "explain": "Количество пользователей по городам"
        },
        "msg_idx": 2
    },
    {
        "kind": "chart", 
        "ts": "2024-01-15T10:31:12",
        "df_pl": None,
        "fig": <Plotly Figure>,
        "meta": {
            "plotly_code": "fig = px.bar(df, x='city', y='count')",
            "title": "График по городам"
        },
        "msg_idx": 2
    }
]
```

## Назначение и важность

### 1. Персистентность данных
- Результаты сохраняются между обновлениями страницы
- История не теряется при навигации по приложению
- Обеспечивает непрерывность работы пользователя

### 2. Экспорт и архивирование
- Возможность скачивания таблиц в CSV/XLSX
- Возможность скачивания графиков в HTML
- Создание архива всей истории в ZIP-формате

### 3. Контекст для LLM
- Модель видит предыдущие результаты
- Может ссылаться на них в новых запросах
- Обеспечивает преемственность диалога

### 4. Пользовательский опыт (UX)
- Пользователь видит всю историю работы
- Может вернуться к предыдущим результатам
- Понимает последовательность действий

## Связанные функции

- **`_render_result()`** - отображение сохраненных результатов в интерфейсе
- **`_history_zip_bytes()`** - создание ZIP-архива для экспорта
- **`_table_number_for()`** - нумерация таблиц для отображения
- **`_df_to_csv_bytes()`** - конвертация таблиц в CSV
- **`_df_to_xlsx_bytes()`** - конвертация таблиц в XLSX

## Обработка ошибок

- Функция не содержит явной обработки ошибок
- Полагается на корректность входных данных
- При `None` в `meta` используется пустой словарь `{}`

## Производительность

- Минимальные накладные расходы
- Простое добавление в список
- Временная метка генерируется только при необходимости

## Критическая важность

Эта функция является **фундаментальной** для:
- Сохранения результатов работы пользователя
- Обеспечения персистентности данных
- Возможности экспорта и архивирования
- Создания контекста для LLM-взаимодействий
- Обеспечения непрерывности пользовательского опыта

**Без неё все результаты терялись бы при каждом обновлении страницы!**

## Пример полного цикла

```python
# 1. Выполнение SQL
df_pl = ch_client.query_run(sql)

# 2. Сохранение результата
_push_result("table", df_pl=df_pl, meta={"sql": sql, "title": "Результаты"})

# 3. Отображение в интерфейсе
_render_result(st.session_state["results"][-1])

# 4. Экспорт (позже)
csv_data = _df_to_csv_bytes(df_pl.to_pandas())
```
