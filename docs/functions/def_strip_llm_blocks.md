# def_strip_llm_blocks

## Описание функции

Функция `_strip_llm_blocks()` очищает ответы LLM от служебных блоков кода, оставляя только понятный пользователю контент для отображения в чате.

## Расположение в коде

**Файл:** `app.py`  
**Строки:** 262-278

## Сигнатура функции

```python
def _strip_llm_blocks(text: str) -> str:
```

## Параметры

### `text: str` - Текст ответа LLM
- Исходный текст с служебными блоками
- **Обязательный параметр**

## Возвращаемое значение

**`str`** - Очищенный текст без служебных блоков

## Что удаляет функция

### Служебные блоки:
- ````title``` - заголовки таблиц
- ````explain``` - объяснения
- ````sql``` - SQL-код
- ````rag``` - RAG-запросы
- ````python``` - код Python
- ````plotly``` - код графиков
- ````table``` - таблицы

## Алгоритм работы

### 1. Проверка входных данных
```python
if not text:
    return text
```
- Безопасная обработка пустых строк
- Предотвращение ошибок при `None`

### 2. Удаление служебных блоков
```python
for tag in ("title", "explain", "sql", "rag", "python", "plotly", "table"):
    text = re.sub(
        rf"```{tag}\s*.*?```",
        "",
        text,
        flags=re.IGNORECASE | re.DOTALL,
    )
```
- Перебор всех служебных тегов
- Регулярное выражение для поиска блоков
- Игнорирование регистра и многострочности

### 3. Очистка лишних переносов
```python
text = re.sub(r"\n{3,}", "\n\n", text).strip()
```
- Замена 3+ переносов на 2
- Удаление лишних пробелов

## Места использования

### 1. Отображение ответов ассистента
```python
cleaned = _strip_llm_blocks(final_reply)
if cleaned:
    st.markdown(cleaned)
```
- Показывает только понятный пользователю текст
- Скрывает технические детали

### 2. Обработка разных режимов
- **SQL-режим** - убирает SQL-код, оставляет объяснения
- **RAG-режим** - убирает RAG-запросы, оставляет ответы
- **Plotly-режим** - убирает код графиков, оставляет описания

## Примеры работы

### Пример 1: Удаление SQL-блока
```python
input_text = """
```title
Топ городов
```

```sql
SELECT city, count(*) FROM users GROUP BY city
```

Вот результаты вашего запроса...
"""

result = _strip_llm_blocks(input_text)
# Результат: "Вот результаты вашего запроса..."
```

### Пример 2: Удаление нескольких блоков
```python
input_text = """
```explain
Статистика по городам
```

```sql
SELECT city, count(*) FROM users GROUP BY city
```

```plotly
fig = px.bar(df, x='city', y='count')
```

График построен!
"""

result = _strip_llm_blocks(input_text)
# Результат: "График построен!"
```

## Зачем это нужно

### 1. **Улучшение UX**
- Пользователь видит только релевантную информацию
- Не засоряется техническими деталями
- Чистый и понятный интерфейс

### 2. **Разделение ответственности**
- **Служебные блоки** - обрабатываются отдельно (SQL выполняется, графики строятся)
- **Текстовые ответы** - показываются в чате
- **Метаданные** - сохраняются для контекста

### 3. **Предотвращение дублирования**
- SQL-код не дублируется в чате (он уже выполнен)
- Графики не показываются как код (они уже отрисованы)
- Заголовки не дублируются (они уже в интерфейсе)

## Обработка ошибок

- Безопасная обработка пустых строк
- Предотвращение ошибок при `None`
- Устойчивость к некорректным данным

## Производительность

- **Временная сложность:** O(n) где n - длина текста
- **Пространственная сложность:** O(n) для результата
- Минимальные накладные расходы
- Простые регулярные выражения

## Критическая важность

Эта функция является **важной** для:
- Создания чистого пользовательского интерфейса
- Разделения технических и пользовательских данных
- Предотвращения дублирования информации
- Улучшения читаемости чата

**Без неё пользователь видел бы весь технический мусор в чате!**

## Практический пример

### **LLM возвращает:**
```
```title
Топ 10 городов
```

```sql
SELECT city, count(*) as user_count 
FROM users 
WHERE created_at >= '2024-01-01'
GROUP BY city 
ORDER BY user_count DESC 
LIMIT 10
```

```explain
Статистика по городам за 2024 год
```

Вот топ городов по количеству пользователей...
```

### **После обработки пользователь видит:**
```
Вот топ городов по количеству пользователей...
```

### **А в интерфейсе отдельно:**
- **Заголовок:** "Топ 10 городов"
- **Таблица:** с данными из SQL
- **Подпись:** "Статистика по городам за 2024 год"

## Связанные функции

- **`_render_result()`** - отображение служебных блоков в интерфейсе
- **`_push_result()`** - сохранение метаданных
- **`_extract_sql_info()`** - анализ SQL для подписей

## Альтернативные подходы

### ❌ **Показывать все блоки**
```python
# Плохо: пользователь видит технический мусор
st.markdown(final_reply)  # Показывает все блоки
```

### ❌ **Ручная фильтрация**
```python
# Плохо: сложно и ненадежно
if "```sql" not in text:
    st.markdown(text)
```

### ✅ **Текущий подход**
- Автоматическая очистка
- Надежная обработка
- Чистый интерфейс
