# Функция `_get_title()`

## Назначение
Унифицированная функция для получения заголовков таблиц и графиков с умным fallback-механизмом.

## Параметры
- `meta: dict` - Метаданные результата (заголовок, SQL, и т.д.)
- `pdf: pd.DataFrame = None` - DataFrame для анализа (опционально)
- `fallback_source: str = "sql"` - Источник fallback ("sql" или "context")

## Возвращаемое значение
- `str` - Заголовок для отображения

## Алгоритм работы

### 1. Проверка явного заголовка
```python
title = (meta.get("title") or "").strip()
if title:
    return title
```
Если LLM дал явный заголовок - возвращает его без изменений.

### 2. Fallback 1: Умный анализ SQL (для таблиц)
```python
if fallback_source == "sql" and pdf is not None:
    sql = (meta.get("sql") or "").strip()
    if sql:
        info = _extract_sql_info(sql, pdf)
        
        if info.get("limit"):
            # Поиск ключевой колонки
            lead = None
            for c in info["columns"]:
                if re.search(r"(city|город|category|катег|product|товар|region|регион|name|назв)", c, flags=re.IGNORECASE):
                    lead = c
                    break
            return f'Топ {info["limit"]}' + (f" по «{lead}»" if lead else "")
```
Анализирует SQL-запрос и создает умный заголовок типа "Топ 10 по «city»".

### 3. Fallback 2: Контекстный fallback (для графиков)
```python
if fallback_source == "context":
    title = st.session_state.get("last_sql_meta", {}).get("title", "").strip()
    if title:
        return title
```
Использует заголовок из предыдущего SQL-запроса для контекстной связи.

### 4. Дефолтный заголовок
```python
return "Результаты запроса"
```
Если ничего не подошло - возвращает общий заголовок.

## Примеры использования

### Для таблиц (с анализом данных)
```python
title = _get_title(meta, pdf, "sql")
# Результат: "Топ 10 по «city»" или "Анализ продаж по городам"
```

### Для графиков (с контекстным fallback)
```python
title = _get_title(meta, fallback_source="context")
# Результат: "Топ 10 по «city»" (из предыдущего SQL) или "Результаты запроса"
```

## Ключевые особенности

### 1. Унификация
- Одна функция для таблиц и графиков
- Устранение дублирования кода
- Упрощение поддержки

### 2. Умный анализ
- Анализ SQL-структуры
- Поиск ключевых колонок
- Создание осмысленных заголовков

### 3. Контекстная связь
- Графики наследуют заголовки от таблиц
- Поддержка диалоговой преемственности
- Улучшение UX

### 4. Graceful degradation
- Всегда возвращает заголовок
- Никогда не падает
- Fallback на безопасные значения

## Связь с другими функциями

- **Использует:** `_extract_sql_info()` для анализа SQL
- **Используется в:** `_render_table()`, `_render_chart()`
- **Влияет на:** UX, понимание контекста, навигацию по результатам

## Преимущества унификации

### До унификации:
- Две похожие функции с дублированием логики
- Путаница в выборе функции
- Сложность поддержки

### После унификации:
- Одна универсальная функция
- Четкое разделение по параметрам
- Упрощение кода и поддержки

## Важность
Функция критически важна для создания понятных и осмысленных заголовков, которые помогают пользователю понимать контекст данных и строить на них дальнейшие запросы.
